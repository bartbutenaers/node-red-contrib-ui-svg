<!--
  Copyright 2019, Bart Butenaers, Stephen McLaughlin
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<style>
    .ui-autocomplete {
        max-height: 100px;
        overflow-y: auto;
        overflow-x: hidden; /* prevent horizontal scrollbar */
        /*padding-right: 20px;/* add padding to account for vertical scrollbar */
    } 
    .ui-dialog .ui-dialog-content {
        padding: 0px 0px 0px 0px;
    }
    .msgboxOuter {
        display: table; 
        width: 100px; 
        height:100px; 
        overflow: hidden;
    }
    .msgboxOuter .msgboxInner {
        display: table-cell;
        vertical-align: middle;
        width: 100%;
        margin: 0 auto;
        text-align: left;
    }
    .msgboxInnerLeft{
        padding: 20px 0px 10px 20px;
        float: left; 
    }
    .msgboxInnerRight{
        padding: 20px 10px 10px 20px;
        width: 300px; 
    }
    .svgButtonIcon {
        padding: 4px 0px 0px 0px;
        width: 40px;
        text-align: center;
        height: 40px;
    }
    .svgButtonText {
        /* padding: 4px 4px 4px 4px; */
        text-align: center;
    }

    .svgButton {
        box-shadow:inset 0px 0px 15px 3px #23395e;
        background:linear-gradient(to bottom, #2e466e 5%, #415989 100%);
        background-color:#2e466e;
        border-radius:20px;
        border:1px solid #1f2f47;
        display:inline-block;
        cursor:pointer;
        color:#ffffff;
        font-family:Arial;
        font-size:15px;
        padding:10px 13px;
        text-decoration:none;
        text-shadow:0px 1px 0px #263666;
        text-align: -webkit-center;
    }
    .svgButton:hover {
        background:linear-gradient(to bottom, #415989 5%, #2e466e 100%);
        background-color:#415989;
    }
    .svgButton:active {
        position:relative;
        top:1px;
    }

</style>


<script src="ui_svg_graphics/lib/jschannel.js"></script>
<script src="ui_svg_graphics/lib/beautify-html.js"></script>



<script type="text/javascript">
    const messageBox = {
        show: function(message, title, faicon, options) {
            options = options || {}
            var msgbox = $('#ui-svg-message-box');
            if (msgbox.length == 0) {
                var msgboxhtml =    '<div id="ui-svg-message-box" title="" class="msgboxOuter" >' +
                                    '  <div id="ui-svg-message-box-icon-div" class="msgboxInner">' +
                                    '    <div class="msgboxInnerLeft">' +
                                    '      <i id="ui-svg-message-box-icon"> </i>' +
                                    '    </div>' +
                                    '  </div>' +
                                    '  <div class="msgboxInner">' +
                                    '    <div id="ui-svg-message-box-text" class="msgboxInnerRight" >' +
                                    '    </div>' +
                                    '  </div>' +
                                    '</div>'
                msgbox = $(msgboxhtml).appendTo('body');
            }
            var icon = msgbox.find("#ui-svg-message-box-icon");
            var iconDiv = msgbox.find("#ui-svg-message-box-icon-div");
            if(faicon && icon && icon.length){
                icon[0].className = "fa fa-4x " + faicon;
                iconDiv.show();
            } else {
                iconDiv.hide();
            }
            var text = msgbox.find("#ui-svg-message-box-text");
            text.html(message);
            msgbox.attr("title",title);
            msgbox.dialog({
                resizable: options.resizable === false ? options.resizable : true,
                height: options.height || 100,
                width: options.width || 400,
                modal: options.modal === false ? options.modal : true,
                buttons: options.buttons,
                close: function() {
                    $(this).dialog("destroy");
                    $(this).empty();//ensure old content is completely removed
                    $(this).remove();
                }
            });
        },
        close: function() {
            $('#ui-svg-message-box').dialog( "close" );
        }
    }
    
    // Collect information for the auto-complete fields
    function updateSvgIdHelpers(node, svgStr) {
        console.log("updateSvgIdHelpers");
        
        // Reset all information that we have previously collected
        node.nonAnimationClasses = [];
        node.animationClasses = [];
        node.animationListClasses = [];
        node.animationIds = [];
        node.animationIdSelectors = [];
        node.nonAnimationIds = [];
        node.nonAnimationIdSelectors = [];
        node.nonAnimationIdsAndActions = [];
        node.animationIdsAndActions = [];
        
        // Convert the SVG string into a temporary DOM tree, which allows us to search easily through the SVG.
        // See https://discourse.nodered.org/t/temporary-dom-elements-somewhere-cached/15520
        var svgElement = new DOMParser().parseFromString(svgStr, "image/svg+xml");

        svgElement.querySelectorAll('[class]').forEach(function (element) {
            element.classList.forEach(function (className) {
                if(!className) return;
                var _class = "." + className;
                var ele = element.tagName;
                ele = ele.trim().toLowerCase();
                if (ele == "set" || ele == "animate" || ele == "animatemotion" || ele == "animatecolor" || ele == "animatetransform") {
                    if (node.animationClasses.indexOf(_class) < 0) {
                        node.animationClasses.push(_class)
                    }
                } else {
                    if (node.nonAnimationClasses.indexOf(_class) < 0) {
                        node.nonAnimationClasses.push(_class)
                    }
                }
            })
        })
        svgElement.querySelectorAll('*[id]').forEach(function (element) {
            if(!element.id) return;
            
            var id = element.id;
            var ele = element.tagName;
            ele = ele.trim().toLowerCase();
            if(ele == "style") return;
            if (ele == "set" || ele == "animate" || ele == "animatemotion" || ele == "animatecolor" || ele == "animatetransform") {
                if (node.animationIds.indexOf(id) < 0) {
                    node.animationIds.push(id)
                    node.animationIdSelectors.push("#"+id)
                    node.animationIdsAndActions.push(id)
                    node.animationIdsAndActions.push(id + ".begin");
                    node.animationIdsAndActions.push(id + ".end");
                    node.animationIdsAndActions.push(id + ".repeat(1)");
                }
            } else if(ele != "style" ) {
                if (node.nonAnimationIds.indexOf(id) < 0) {
                    node.nonAnimationIds.push(id);
                    node.nonAnimationIdSelectors.push("#"+id)
                    node.nonAnimationIdsAndActions.push(id + ".click");
                    node.nonAnimationIdsAndActions.push(id + ".dblclick");
                    node.nonAnimationIdsAndActions.push(id + ".contextmenu");
                    node.nonAnimationIdsAndActions.push(id + ".mouseover");
                    node.nonAnimationIdsAndActions.push(id + ".mouseout");
                    node.nonAnimationIdsAndActions.push(id + ".mouseup");
                    node.nonAnimationIdsAndActions.push(id + ".mousedown");
                    node.nonAnimationIdsAndActions.push(id + ".focus");
                    node.nonAnimationIdsAndActions.push(id + ".focusin");
                    node.nonAnimationIdsAndActions.push(id + ".focusout");
                    node.nonAnimationIdsAndActions.push(id + ".blur");
                    node.nonAnimationIdsAndActions.push(id + ".keyup");
                    node.nonAnimationIdsAndActions.push(id + ".keydown");
                    node.nonAnimationIdsAndActions.push(id + ".touchstart");
                    node.nonAnimationIdsAndActions.push(id + ".touchend");
                }
            }
        })
        
        //Get all animation ids specified by the SMIL animations editable list...
        var smilAnimationsList = $("#node-input-animations-container").editableList('items');
        smilAnimationsList.each(function(i) {
            var aid = $(this).find(".node-input-animation-id").val();    
            var cv = $(this).find(".node-input-animation-classValue").val();    
                        
            if (cv && node.animationListClasses.indexOf(cv) < 0) {
                node.animationListClasses.push(cv);
            }
            if(!aid) return;            
            if (node.animationIds.indexOf(aid) < 0) {
                node.animationIds.push(aid);
                node.animationIdsAndActions.push(aid + ".begin");
                node.animationIdsAndActions.push(aid + ".end");
                node.animationIdsAndActions.push(aid + ".repeat(1)");
            }
        });
    }
    
    function updateEditorHeight(node, editor) {
        console.log("updateEditorHeight");
        //resize the tab content divs to available height
        var formRows = $("#dialog-form>div:not(#node-svg-tabs-content)");
        var height = $("#dialog-form").height() - 5;
        for (let i=0; i < formRows.length; i++) {
            height -= $(formRows[i]).outerHeight(true);
        }
        $("#node-svg-tabs-content").css("height",height+"px");//set size of tabs area
        //now resize the item with class form-row-auto-height
        var tabs = $('.node-svg-tab-content');
        for (let index = 0; index < tabs.length; index++) {
            let tab = $(tabs[index]);
            tab.css("height",height+"px");
            let expandRow = $(tab.find('.form-row-auto-height'));
            if(expandRow && expandRow.length){
                let tabHeight = height;
                let childRows = tab.find('.form-row:not(.form-row-auto-height)');
                for (let i=0; i<childRows.size(); i++) {
                    tabHeight -= $(childRows[i]).outerHeight(true);
                }
                let ol = $(expandRow.find(".red-ui-editableList-list"));
                if(ol && ol.length){
                    ol.editableList("height",tabHeight);
                } else {
                    expandRow.css("height",tabHeight+"px");
                }
            } 
        }
        if ( editor ) {
            // Is the editor is in full-screen? ...
            node.fullscreen = document.fullscreenElement ? true : false;
            var rows = $("#node-svg-tab-source>div:not(.node-source-editor-row)");
            var height = $("#node-svg-tab-source").height() - 25;
            for (var i=0; i<rows.size(); i++) {
                height = height - $(rows[i]).outerHeight(true);
            }
            if ($('#node-input-templateScope').val() === "global") { height += 232; }
           
            if (node.fullscreen) {
                $('#node-expand-svg-source').html('<i class="fa fa-compress"></i>')//compress icon
            } else {               
                $('#node-expand-svg-source').html('<i class="fa fa-expand"></i>')//expand icon
            }
            
            // Set the height of the edit box
            $('#node-input-svg-source').css('height',height+'px');
            // Get the content to match the edit box size
            if(editor) editor.resize();
        }
        $(".node-input-clickable-payload").typedInput('width');//layout workaround until NR V1 https://discourse.nodered.org/t/toggle-visibility-of-typedinput-field-layout-issue/12756/11
    } 
    function getAnimationObjectFromFormRow(ele){
        var row = $(ele);
        var id            = row.find(".node-input-animation-id").val();
        var targetId      = row.find(".node-input-animation-targetId").val();
        var classValue    = row.find(".node-input-animation-classValue").val();
        var attributeName = row.find(".node-input-animation-attributeName").val();
        var fromValue     = row.find(".node-input-animation-fromValue").val();
        var toValue       = row.find(".node-input-animation-toValue").val();
        var trigger       = row.find(".node-input-animation-trigger").val();
        var duration      = row.find(".node-input-animation-duration").val();
        var durationUnit  = row.find(".node-input-animation-durationUnit").val();
        var repeatCount   = row.find(".node-input-animation-repeatCount").val();
        var end           = row.find(".node-input-animation-end").val();
        var delay         = row.find(".node-input-animation-delay").val();
        var delayUnit     = row.find(".node-input-animation-delayUnit").val();
        var otherId       = row.find(".node-input-animation-otherId").val();
        var custom        = row.find(".node-input-animation-custom").val();        
        return {id:id, targetId:targetId, classValue:classValue, attributeName:attributeName, fromValue:fromValue, toValue:toValue, trigger:trigger, duration:duration, durationUnit:durationUnit, repeatCount:repeatCount, end:end, delay:delay, otherId:otherId, delayUnit:delayUnit, custom:custom};
    }
    function getBindingFromFormRow(ele){
        var row = $(ele);
        return {
            selector : row.find(".node-input-binding-selector").val(),
            bindSource : row.find(".node-input-binding-source").val(),
            bindType : row.find(".node-input-binding-type").val(),
            attribute : row.find(".node-input-binding-attribute").val()
        };
    }
    RED.nodes.registerType('ui_svg_graphics',{
        category: 'dashboard',
        color: 'rgb( 63, 173, 181)',
        defaults: {
            group: {type: 'ui_group', required:true},
            order: {value: 0},
            width: {
                value: 0,
                validate: function(v) {
                    var valid = true
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()|| this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }},
            height: {value: 0},
            svgString: {value: '<svg x="0" y="0" height="100" viewBox="0 0 100 100" width="100" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg>'},
            clickableShapes: {value: []},
            smilAnimations: {value: []},
            bindings: {value: []},
            showCoordinates: {value: false},
            autoFormatAfterEdit: {value: false},
            outputField: {value: "payload"},
            editorUrl: {value: "http://drawsvg.org/drawsvg.html"},
            //showMouseLines: {value: false},
            directory: {value: ""},
            panEnabled: {value: false},
            zoomEnabled: {value: false},
            controlIconsEnabled: {value: false},
            dblClickZoomEnabled: {value: false},
            mouseWheelZoomEnabled: {value: false},
            name: {value: ''}
        },
        inputs:1,
        outputs:1,
        icon: "svg.png",
        align: 'left',
        paletteLabel:"SVG graphics",
        label: function() {
            return this.name || "SVG graphics";
        },
        oneditprepare: function() {
            var node = this;
            
            // Make sure the autocomplete fields at least refer to Iterable node fields...
            // See https://github.com/bartbutenaers/node-red-contrib-ui-svg/issues/33
            node.nonAnimationClasses = [];
            node.animationClasses = [];
            node.animationListClasses = [];
            node.animationIds = [];
            node.animationIdSelectors = [];
            node.nonAnimationIds = [];
            node.nonAnimationIdSelectors = [];
            node.nonAnimationIdsAndActions = [];
            node.animationIdsAndActions = [];
            
            //list of animatable attributes
            node.attrList = [
                'clipPathUnits', 'cx', 'cy', 'd', 'display', 'dx', 'dy', 'fill', 'fx',
                'fy', 'gradientTransform', 'gradientUnits', 'height', 'lengthAdjust',
                'markerHeight', 'markerUnits', 'markerWidth', 'maskContentUnits',
                'maskUnits', 'method', 'offset', 'orient', 'pathLength',
                'patternContentUnits', 'patternTransform', 'patternUnits', 'points',
                'preserveAspectRatio', 'r', 'refX', 'refY', 'rotate', 'rx', 'ry',
                'spacing', 'spreadMethod', 'startOffset', 'textLength', 'transform',
                'viewBox', "visibility", 'width', 'x', 'x1', 'x2', 'y', 'y1', 'y2',
            ]   
            
            node.initialised = false;
            window.node_ace_editor = null;
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            if (typeof this.templateScope === 'undefined') {
                this.templateScope = 'local';
                $('#node-input-templateScope').val(this.templateScope);
            }
            $('#node-input-templateScope').on('change', function() {
                if ($('#node-input-templateScope').val() === 'global') {
                    $('#template-row-group, #template-row-size, #template-pass-store').hide();
                    node._def.defaults.group.required = false;
                }
                else {
                    $('#template-row-group, #template-row-size, #template-pass-store').show();
                    node._def.defaults.group.required = true;
                }
                var rows = $("#dialog-form>div:not(.node-source-editor-row)");
                var height = $("#dialog-form").height();
                for (var i=0; i<rows.size(); i++) {
                    height = height - $(rows[i]).outerHeight(true);
                }
                if ($('#node-input-templateScope').val() === "global") { height += 240; }
                var editorRow = $("#dialog-form>div.node-source-editor-row");
                height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
                $(".node-source-editor").css("height",height+"px");
                if (this.editor) { this.editor.resize(); }
            })
            
            // Show tabsheets
            node.tabs = RED.tabs.create({
                id: "node-svg-tabs",
                onchange: function(tab) {
                    //console.log("tabs.onchange",tab);
                    // Show only the content (i.e. the children) of the selected tabsheet, and hide the others
                    $("#node-svg-tabs-content").children().hide();
                    $("#" + tab.id).show();
                    updateEditorHeight(node,node.editor);
                    
                    if(tab.id == "node-svg-tab-animations" || tab.id == "node-svg-tab-clickable" || tab.id == "node-svg-tab-binding"){
                        let svgStr = node.editor ? node.editor.getValue() : ""; 
                        try {
                            // When tabsheet changes, all autocomplete sources should be updated (since element ids, ... might have changed)
                            updateSvgIdHelpers(node, svgStr);    
                        } 
                        catch (error) {
                            console.error(error)
                        }
                    }
                    else if (tab.id == "node-svg-tab-editor") {
                        updateSvgEditorButton();
                    }
                }
            });
            node.tabs.addTab({
                id: "node-svg-tab-editor",
                label: "Editor"
            });
            node.tabs.addTab({
                id: "node-svg-tab-source",
                label: "SVG source"
            });
            node.tabs.addTab({
                id: "node-svg-tab-animations",
                label: "Animations"
            });
            node.tabs.addTab({
                id: "node-svg-tab-clickable",
                label: "Events"
            });
            node.tabs.addTab({
                id: "node-svg-tab-binding",
                label: "Input Bind"
            });
            node.tabs.addTab({
                id: "node-svg-tab-settings",
                label: "Settings"
            });  
            function updateSvgEditorButton() {
                var svgEditorButton = $("#node-display-svg-popup");
                var editorUrlMissing = $("#node-display-svg-popup-no-url");
                if ($("#node-input-editorUrl").val().trim()) {
                    svgEditorButton.show();
                    editorUrlMissing.hide();
                } else {
                    svgEditorButton.hide();
                    editorUrlMissing.show();
                }
            }
            updateSvgEditorButton();
            var selectSettingsTab = function () {
                this.tabs.activateTab("node-svg-tab-settings")
            }.bind(node)
            //add click event to "settings" link in the "no url" warning
            $("#gotoSettingsButton").click(selectSettingsTab);

            this.fullscreen = false;
            this.editor = RED.editor.createEditor({
                id: 'node-input-svg-source',
                mode: 'ace/mode/html',
                value: $("#node-input-svgString").val()
            });
            node.editor.setFontSize(14); 
            window.node_ace_editor = node.editor;
            
            RED.library.create({
                url:"uitemplates", // where to get the data from
                type:"ui_template", // the type of object the library is for
                editor:this.editor, // the field name the main text body goes to
                mode:"ace/mode/svg",
                fields:['name']
            });
            this.editor.focus();
            
            var fullScrElement = $('#node-svg-tab-source')[0];
            var fsr = fullScrElement.requestFullscreen || fullScrElement.mozRequestFullScreen || fullScrElement.webkitRequestFullscreen || fullScrElement.msRequestFullScreen;
            if(fsr){
                $('#node-expand-svg-source').click(function(e) {
                    e.preventDefault()
                    if (node.fullscreen === false) {
                        if (fsr) {
                            fsr.call(fullScrElement);//triggers oneditresize()
                        }
                    } else {
                        document.exitFullscreen();//triggers oneditresize()
                    }
                })
            } else {
                $('#node-expand-svg-source').hide();
            }
            
            function addPropertyRow(container, propertyName) {
                var propertyRow = $('<div/>',{style:"margin-top:8px;"}).appendTo(container);
                $('<div/>', {style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                .text(propertyName)
                .appendTo(propertyRow);
                
                return propertyRow;
            }
            
            function getTitle(animation) {
                if (animation && animation.id != "") {
                    return "Animation ( " + animation.id + " : '" + animation.targetId + "' : '" + animation.attributeName + "' )";
                }
                else {
                    return "Animation ( unknown id )";
                }
            }
            
            function updateTitle(titleField, ele){
                var par = $(ele).parent().parent();
                var anim = getAnimationObjectFromFormRow(par);
                var newTitle = getTitle(anim);
                titleField.text(newTitle);
            }
            
            function tagSplit(val) {
                return val.split(/;\s*/);
            }
            
            function extractLastTag(term) {
                return tagSplit(term).pop();
            }
            
            // Create a table of (SMIL) animations
            // Columns: element id - attributeName - from - to - duration - repeatCount - end
            var smilAnimationsList = $("#node-input-animations-container").css('min-height','150px').css('min-width','400px').editableList({
                addItem: function(container, i, animation) {
                    // By default the list items will be compressed, so show the expand icon
                    var expandIcon = "fa fa-angle-right";
                    
                    // When animation === {} then we have a new list item (i.e. user pressed the addItem button)
                    if (Object.keys(animation).length === 0) {
                        // Initialize new items in the list.
                        animation = {
                            id            : "", 
                            targetId      : "",
                            attributeName : "",
                            classValue    : "",
                            fromValue     : "",
                            duration      : 1,
                            durationUnit   : "s",
                            repeatCount   : 0,
                            end           : "restore",
                            trigger       : "msg",
                            delay         : 1,
                            delayUnit     : "s",
                            otherId       : "",
                            custom        : ""
                        };
                        
                        // New list items should be expanded by default, so show a compress icon.
                        // This way the user becomes aware which properties the new widget offers...
                        expandIcon = "fa fa-angle-down";
                    }
                    
                    if(animation.expand){
                        delete animation.expand
                        expandIcon = "fa fa-angle-down";
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    
                    var headerRow = $('<div/>').appendTo(container);
                    
                    // Show a click-able expand/compress icon before each header row.
                    var expandButton = $('<span/>', {style: "margin-left:5px; margin-right:10px;"}).html('<i class="' + expandIcon + '"></i>').appendTo(headerRow);
                    
                    // The header line title depends on the animation id
                    var title = getTitle(animation);
                    
                    var titleField = $('<span/>', {style: "margin-left:10px; margin-right:10px; font-weight:Bold"}).text(title).appendTo(headerRow);
                    titleField.click(function(evt){
                        expandButton.trigger( "click" )
                    })
                    // The COMMON ROWS contain the common animation properties:
                    // - Animation id
                    // - Target id
                    // - Attribute name
                    // - From value
                    // - To value
                    // - Duration + DurationUnit
                    // - Repeat count
                    // - End
                    // - Trigger type
                    
                    // Add an 'animation id' property row
                    var animationIdRow = addPropertyRow(container, "Animation id");
                    var animationIdField = $('<input/>', {class: "node-input-animation-id", style: "width:180px; margin-right:10px;", type: "text"}).appendTo(animationIdRow);
                    animationIdField.val(animation.id);
                    animationIdField.on("change", function(){
                        updateTitle(titleField, this)
                    });
                    $('<span/>').text('%').appendTo(animationIdField);         
                                    
                    // Add a 'target id' property row
                    var targetIdRow = addPropertyRow(container, "Target Element Id");
                    var targetIdField = $('<input/>', {class: "node-input-animation-targetId", style: "width:180px; margin-right:10px;", type: "text"}).appendTo(targetIdRow);
                    targetIdField.val(animation.targetId);
                    targetIdField.autocomplete({
                        source: function(req, add){    
                            add($.ui.autocomplete.filter(node.nonAnimationIds || [] , req.term));
                        }
                    });
                    targetIdField.on("change", function(){
                        updateTitle(titleField, this)
                    });
                    $('<span/>').text('%').appendTo(targetIdField);
                    
                    // Add a 'class' property row
                    var classValueRow = addPropertyRow(container, "Class");
                    var classValueField = $('<input/>', {class: "node-input-animation-classValue", style: "width:180px; margin-right:10px;", type: "text", placeholder: "class"}).appendTo(classValueRow);
                    classValueField.val(animation.classValue);
                    classValueField.autocomplete({
                        source: function(req, add){        
                            add($.ui.autocomplete.filter(node.animationListClasses || [],req.term));
                        }
                    });
                    $('<span/>').text('%').appendTo(classValueField);
                    
                    // Add an 'attribute name' property row
                    var attributeNameRow = addPropertyRow(container, "Attribute name");
                    var attributeNameField = $('<input/>', {class: "node-input-animation-attributeName", style: "width:180px; margin-right:10px;", type: "text"}).appendTo(attributeNameRow);
                    attributeNameField.val(animation.attributeName);
                    attributeNameField.autocomplete({
                        source: function(req, add){     
                            add($.ui.autocomplete.filter(node.attrList || [], req.term));
                        }
                    });
                    attributeNameField.on("change", function(){
                        updateTitle(titleField, this)
                    });
                    $('<span/>').text('%').appendTo(attributeNameField); 
                    
                    // Add a 'from / to value' property row
                    var fromToValueRow = addPropertyRow(container, "From / To");
                    var fromValueField = $('<input/>', {class: "node-input-animation-fromValue", style: "width:180px; margin-right:10px;", type: "text", placeholder: "from"}).appendTo(fromToValueRow);
                    fromValueField.val(animation.fromValue);
                    $('<span/>').text('%').appendTo(fromValueField);
                    // Add a 'to value' property row
                    var toValueField = $('<input/>', {class: "node-input-animation-toValue", style: "width:180px; margin-right:10px;", type: "text", placeholder: "to"}).appendTo(fromToValueRow);
                    toValueField.val(animation.toValue);
                    $('<span/>').text('%').appendTo(toValueField);
                    // Add a 'duration' property row
                    var durationRow = addPropertyRow(container, "Duration");
                    var durationField = $('<input/>', {class: "node-input-animation-duration", style: "width:180px; margin-right:10px;", type: "number"}).appendTo(durationRow);
                    durationField.val(animation.duration);
                    $('<span/>').text('%').appendTo(durationField);
                    var delayUnitField = $('<select/>', {class: "node-input-animation-durationUnit", style: "width:120px; margin-right:10px;", type: "text"}).appendTo(durationRow);
                    delayUnitField.append($('<option>', {value: "ms", text: 'milliseconds'}));
                    delayUnitField.append($('<option>', {value: "s", text: 'seconds'}));
                    delayUnitField.append($('<option>', {value: "min", text: 'minutes'}));
                    delayUnitField.val(animation.durationUnit || "s");
                    
                    // Add a 'repeat count' property row
                    var repeatCountRow = addPropertyRow(container, "Repeat count");
                    var repeatCountField = $('<input/>', {class: "node-input-animation-repeatCount", style: "width:180px; margin-right:10px;", type: "number"}).appendTo(repeatCountRow);
                    repeatCountField.val(animation.repeatCount);
                    $('<span/>').text('%').appendTo(repeatCountField);       
                    
                    // Add a 'animation end' property row
                    var endRow = addPropertyRow(container, "Animation end");
                    var endField = $('<select/>', {class: "node-input-animation-end", style: "width:180px; margin-right:10px;", type: "text"}).appendTo(endRow);
                    endField.append($('<option>', {value: "freeze", text: 'Freeze new value'}));
                    endField.append($('<option>', {value: "restore", text: 'Restore original value'}));
                    endField.val(animation.end || "restore");//SMIL default is restore                    
                    
                    // Add a 'trigger' property row
                    var triggerRow = addPropertyRow(container, "Trigger");
                    var triggerField = $('<select/>',{class:"node-input-animation-trigger", style:"width:180px; margin-right:10px;"}).appendTo(triggerRow);
                    triggerField.append($("<option></option>").val('msg').text("Input message"));
                    triggerField.append($("<option></option>").val('time').text("Time delay"));
                    //triggerField.append($("<option></option>").val('anim').text("Other animation"));
                    triggerField.append($("<option></option>").val('cust').text("Custom"));
                    triggerField.val(animation.trigger);
    
                    expandButton.click(function(e) {
                        e.preventDefault();
                        
                        // Switch the icon between expand and compress
                        if (this.firstElementChild.className === "fa fa-angle-right") {
                            this.firstElementChild.className = "fa fa-angle-down";
                        }
                        else {
                            this.firstElementChild.className = "fa fa-angle-right";
                        }
                    
                        // Only show the relevant widget type properties
                        triggerField.change();
                    });
                    
                    // The (common) row ends here ...
                    // The OTHER rows will only be visible depending on the animation trigger type:
                    // - Delay
                    // - Other id
                    // - Custom
            
                    // Add a 'delay' property row
                    var delayRow = addPropertyRow(container, "Delay");
                    var delayField = $('<input/>', {class: "node-input-animation-delay", style: "width:160px; margin-right:10px;", type: "number"}).appendTo(delayRow);
                    delayField.val(animation.delay);
                    $('<span/>').text('%').appendTo(delayField);
                    var delayUnitField = $('<select/>', {class: "node-input-animation-delayUnit", style: "width:120px; margin-right:10px;", type: "text"}).appendTo(delayRow);
                    delayUnitField.append($('<option>', {value: "ms", text: 'milliseconds'}));
                    delayUnitField.append($('<option>', {value: "s", text: 'seconds'}));
                    delayUnitField.append($('<option>', {value: "min", text: 'minutes'}));
                    delayUnitField.val(animation.delayUnit || "s");
                    
                    // Add a 'custom' property row
                    var customRow = addPropertyRow(container, "Custom");
                    var customField = $('<input/>', {class: "node-input-animation-custom", style: "width:70%; margin-right:10px;", type: "text"}).appendTo(customRow);
                    customField.val(animation.custom);
                    customField.on("keydown", function (event) {
                        if($(this).autocomplete("instance").menu.active){
                            var appendChar = "; ";
                            var takeInput = true;
                            switch (event.keyCode) {
                                case $.ui.keyCode.RIGHT:
                                appendChar = "";
                                break;
                                case 186:
                                appendChar = "; ";
                                break;
                                case $.ui.keyCode.PERIOD:
                                appendChar = ".";
                                break;
                                default:
                                takeInput = false;
                            }
                            
                            if (event.keyCode === $.ui.keyCode.TAB) {
                                event.preventDefault();// don't navigate away from the field on tab when selecting an item
                            } else if (takeInput) {
                                let terms =  tagSplit(this.value);
                                let selected = $(this).autocomplete("instance").menu.active.text()
                                terms.pop();// remove the current input 
                                terms.push(selected + appendChar); // add the selected item
                                this.value = terms.join("; ");
                                event.preventDefault();// don't navigate away from the field
                            }
                        }
                    })
                    .on("click", function (event) {
                        //show dropdown on click (disabled/annoying/problematic)
                        //$( this ).autocomplete( "search", "" )
                    })
                    .autocomplete({
                        minLength: 0,
                        source: function (request, response) {
                            //TODO: Consider how to handle editing in middle of string
                            //currently, the last tag (after last ;) is used.
                            let list;
                            let lastTag = extractLastTag(request.term);
                            if(lastTag.includes(".")){
                                list = [...node.nonAnimationIdsAndActions,...node.animationIdsAndActions]; 
                            } else {
                                list = [...node.nonAnimationIds, ...node.animationIds]; 
                            }
                            // delegate back to autocomplete, but extract the last term
                            response($.ui.autocomplete.filter(list, lastTag));
                        },
                        focus: function () {
                            // prevent value inserted on focus
                            return false;
                        },
                        select: function (event, ui) {
                            var terms = tagSplit(this.value);
                            terms.pop();// remove the current input 
                            terms.push(ui.item.value); // add the selected item
                            // add placeholder to get the comma-and-space at the end
                            terms.push("");
                            this.value = terms.join("; ");
                            return false;
                        }
                    });                 
                    $('<span/>').text('%').appendTo(customField);
                    customRow.append($("<i />", {class:"fa fa-question", title:"Press down to select, right to accept, dot to access properties, semicolon/enter/tab to complete the entry."}));
                    
                    //add duplicate button
                    var duplicateButton = $('<a/>', {class: "red-ui-editableList-item-remove red-ui-button red-ui-button-small", style: "margin-right: 28px",  title: "Duplicate this entry"}).appendTo(container);
                    duplicateButton.html('<i class="fa fa-clone"></i>')
                    var anim = animation;
                    var animList = smilAnimationsList;
                    duplicateButton.click(function(evt){
                        var duplicate = getAnimationObjectFromFormRow($(this).parent());
                        duplicate.id += "_copy";
                        duplicate.expand = true;
                        animList.editableList('addItem', duplicate);
                    })
                    
                    // When the trigger type changes, only the relevant property rows should be visible
                    triggerField.change(function() {
                        var triggerType = $(this).val();
                        
                        animationIdRow.hide();
                        targetIdRow.hide();
                        attributeNameRow.hide();
                        classValueRow.hide();
                        fromToValueRow.hide();
                        durationRow.hide();
                        repeatCountRow.hide();
                        endRow.hide();
                        triggerRow.hide();
                        delayRow.hide();
                        //otherIdRow.hide();
                        customRow.hide();
                        
                        // When the button shows a 'compress' icon, this means that the list item is currently expanded
                        // (i.e. that all relevant property rows should be visible)
                        if (expandButton.children()[0].className === "fa fa-angle-down") {
                            // The (common) header rows should be visible for all widget types
                            animationIdRow.show();
                            targetIdRow.show();
                            attributeNameRow.show();
                            classValueRow.show();
                            fromToValueRow.show();
                            durationRow.show();
                            repeatCountRow.show();
                            endRow.show();
                            triggerRow.show();
                        
                            // Some other property rows should only be visible for specific trigger types
                            switch (triggerType) {
                                case 'msg':
                                    // No extra property rows to show
                                    break;
                                case 'time':
                                    delayRow.show();                                   
                                    break;
                                case 'cust':
                                    customRow.show();
                                    break;
                            }
                        }
                    });
                    
                    // Only show the relevant widget type properties
                    triggerField.change();
                },                    
                removable: true,
                sortable: false
            });
            
            // Show all the animations (stored in this node) into the editableList
            if (this.smilAnimations) {
                this.smilAnimations.forEach(function (smilAnimation, index) {
                    smilAnimationsList.editableList('addItem', smilAnimation);
                });
            }
            // Create a table of clickable shapes
            const supportedPayloadTypes = ['flow', 'global', 'str', 'num', 'bool', 'json', 'date'];
            const defaultPayloadType = "str";
            var clickableShapesList = $("#node-input-clickable-container").css('min-height','150px').css('min-width','450px').editableList({
                header: $("<div>").append($.parseHTML(
                   "<div style='width:17%; margin-left:5px; display: inline-grid'><b>Selector</b></div>" +
                   "<div style='width:20%; margin-left:5px; display: inline-grid'><b>Action</b></div>" +
                   "<div style='width:38%; margin-left:4px; display: inline-grid' id='node-input-columnPayload'><b>msg.payload</b></div>" +
                   "<div style='width:17%; margin-left:-3px; display: inline-grid'><b>msg.topic</b></div>")),
                addItem: function(container, i, clickableShape) {
                    // Add a new row to the editableList
                    var row = $('<div/>').appendTo(container);
                    
                    // Column 1 : Add an input field (type string) to the new row, that represents the selector for this event to operate on 
                    var targetIdField = $('<input/>',{class:"node-input-clickable-targetId",type:"text",placeholder:"Element Selector"}).css({"width":"17%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    targetIdField.val(clickableShape.targetId);
                    targetIdField.autocomplete({
                        source: function(req, add){  
                            var list = [...node.nonAnimationIdSelectors,...node.nonAnimationClasses] || []
                            add($.ui.autocomplete.filter(list , req.term));
                        }
                    });
                    
                    // Column 2 : Add an input field (type option) to the new row, that represents the action type 
                    var actionField = $('<select/>',{class:"node-input-clickable-action",type:"text",placeholder:"click"}).css({"width":"20%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    var actionOptions = {
                        //https://www.w3.org/TR/2015/WD-SVG2-20150407/interact.html#SVGEvents
                        'click':'Click',//A click is defined as a mousedown and mouseup over the same screen location. Works on tablet too.
                        'dblclick':'Double click',
                        'contextmenu':'Context menu',
                        'mousedown':'Mouse down',//Occurs when the pointing device button is pressed over an element.
                        'mouseup':'Mouse up',//Occurs when the pointing device button is released over an element.
                        'mouseover':'Mouse over',//Occurs when the pointing device is moved onto an element.
                        'mouseout':'Mouse out', //Occurs when the pointing device is moved away from an element
                        //'mousemove':'mousemove', //Occurs when the pointing device is moved while it is over an element.
                        'focus':'Focus',//Occurs when an element receives focus.
                        'focusin':'Focus in',//Occurs when an element is about to receive focus
                        'focusout':'Focus out',//Occurs when an element is about to lose focus.
                        'blur':'Blur',//Occurs when an element loses focus.
                        'keydown':'Key down',//Occurs when a key is pressed down
                        'keyup':'Key up',
                        //https://www.w3.org/TR/touch-events/#list-of-touchevent-types
                        'touchstart':'Touch start', //mobile/tablet only
                        'touchend':'Touch end', //mobile/tablet only
                        // 'touchmove':'touchmove',
                        // 'touchcancel':'touchcancel',
                    }
                    for(var val in actionOptions) {
                        $('<option />', {value: val, text: actionOptions[val]}).appendTo(actionField);
                    }
                    actionField.val(clickableShape.action || "click");
                    // Column 3 : Add a input field (type string) to the new row, that represents the msg.payload content 
                    var payloadField = $('<input/>',{class:"node-input-clickable-payload",type:"text",placeholder:"payload"}).css({"width":"38%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    var payloadTypeField = $('<input/>',{class:"node-input-clickable-payloadType",type:"hidden"}).appendTo(row);
                    var payloadType = supportedPayloadTypes.includes(clickableShape.payloadType) ? clickableShape.payloadType : defaultPayloadType;
                    payloadField.typedInput({
                        default: defaultPayloadType,
                        typeField: payloadTypeField,
                        types: supportedPayloadTypes
                    });
                    payloadField.typedInput("type", payloadType);              
                    payloadField.typedInput("value", clickableShape.payload);  
                    // Column 4 : Add an input field (type string) to the new row, that represents the msg.topic content
                    var topicField = $('<input/>',{class:"node-input-clickable-topic",type:"text",placeholder:"Topic"}).css({"width":"17%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    topicField.val(clickableShape.topic);
                    
                    // When there is not yet a topic or payload, the target Id should be cloned (when complete) to the topic and payload (as a default value).
                    targetIdField.on("change", function(){
                        
                        if (payloadType === "str" && !payloadField.typedInput("value")) {
                            payloadField.typedInput('value',$(this).val());
                        }
                        
                        if (!topicField.val() || topicField.val() === "") {
                            topicField.val($(this).val());
                        }
                    });
                },
                removable: true
            });
            
            // Show all the clickable shapes (stored in this node) into the editableList
            if (this.clickableShapes) {
                this.clickableShapes.forEach(function (clickableShape, index) {
                    clickableShapesList.editableList('addItem', {targetId:clickableShape.targetId, action:clickableShape.action, payload:clickableShape.payload, payloadType:clickableShape.payloadType, topic:clickableShape.topic});
                });
            }
            
            // Make sure the column name keeps being identical to the selected output message field
            $('#node-input-outputField').on('change', function() {
                var outputField = $('#node-input-outputField').val();
                $('#node-input-columnPayload').css("font-weight","Bold");
                $('#node-input-columnPayload').text("msg." + outputField);
            });
            $('#node-input-outputField').change();
            
            var bindingList = $("#node-input-binding-container").css('min-height','150px').css('min-width','450px').editableList({
                header: $("<div>").css({"margin-left":"6px"}).append($.parseHTML(
                    "<div style='width:28%; margin-left:5px; display: inline-grid'><b>Binding Source</b></div>" +
                    "<div style='width:28%; margin-left:1px; display: inline-grid'><b>Selector</b></div>" +  
                    "<div style='width:36%; margin-left:1px; display: inline-grid'><b>Binding Destination</b></div>" 
                )),
                addItem: function(container, i, binding) {
                    // Add a new row to the editableList
                    var row = $('<div/>').appendTo(container);
                    //BINDING SOURCE
                    // Column 1 :  bind msg.xxxx 
                    var bindSourceField = $('<input/>',{class:"node-input-binding-source",type:"text",placeholder:"payload.property"})
                        .css({"width":"28%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    bindSourceField.val(binding.bindSource);  
               
                    //BINDING DESTINATION
                    // Column 2 : [textbox] Selector denoting what elements to add binding to (with autocomplete of .classes & #elementIDs)
                    var targetSelectorField = $('<input/>',{class:"node-input-binding-selector",type:"text",placeholder:"Element Selector"})
                        .css({"width":"28%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    var targetSelectorFieldId = "node-input-binding-selector" + i
                    targetSelectorField.attr("id",targetSelectorFieldId);
                    targetSelectorField.val(binding.selector);
                    targetSelectorField.autocomplete({
                        source: function(req, add){  
                            var list = [...node.nonAnimationIdSelectors,...node.nonAnimationClasses] || []
                            add($.ui.autocomplete.filter(list, req.term));
                        }
                    });
           
                    // Column 3 : [dropdown] Binding Type ["Text Content","Attribute Value"]
                    var bindingTypeField = $('<select/>',{class:"node-input-binding-type",type:"text",placeholder:"click"})
                        .css({"width":"16%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    $('<option />', {value: "text", text: "Text"}).appendTo(bindingTypeField);
                    $('<option />', {value: "attr", text: "Attribute"}).appendTo(bindingTypeField);
                    bindingTypeField.val(binding.bindType || "text");
                    
                    // Column 4 : [textbox] Attribute to update (only used when bindingType == "attr") 
                    var attributeField = $('<input/>',{class:"node-input-binding-attribute",type:"text",placeholder:"attribute"})
                        .css({"width":"20%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    var attributeFieldId = "node-input-binding-attribute" + i
                    attributeField.attr("id",attributeFieldId);
                    attributeField.val(binding.attribute);  
                    attributeField.autocomplete({
                        source: function(req, add){        
                            add($.ui.autocomplete.filter(node.attrList, req.term));

                        }
                    });
                    bindingTypeField.change(function () {
                        if (bindingTypeField.val() === "attr") {
                            attributeField.show();
                        }
                        else {
                            attributeField.hide();
                        }
                    });
                    bindingTypeField.change();
                    //console.log("Created binding row for " +  binding.selector)
                },
                removable: true
            });

            // Add all the binding into the editableList
            if (this.bindings) {
                this.bindings.forEach(function (binding, index) {
                    //console.log("Adding binding row for " +  binding.selector)
                    bindingList.editableList('addItem', {selector:binding.selector, bindSource:binding.bindSource, bindType:binding.bindType, attribute:binding.attribute});
                });
            }
            
            node.initialised = true;
            
            function showDrawSVG(src,title,width,height){
                
                window.svgEditorFrame = $('<iframe id="drawsvg" frameborder="0" marginwidth="0" marginheight="0" allowfullscreen></iframe>');
                window.svgEditorDialogDiv = $("<div id='svg-dialog-div'></div>").append(window.svgEditorFrame).appendTo("body")
                
                // Open the Div (containing an iFrame) in a popup dialog
                window.svgEditorDialog = window.svgEditorDialogDiv.dialog({
                    autoOpen: false,
                    modal: true,
                    resizable: true,
                    width: "auto",
                    height: "auto",
                    minHeight: 440,
                    minWidth: 600,
                    title: title,
                    open: function( event, ui ) {
                        window.svgEditorDialog.closeConfirmed = false;
                        window.svgEditorFrame[0].src = src;
                        window.svgEditorFrame.attr({
                            width: "99%",// +width,
                            height:"99%",// +height,
                            src: src
                        });
                        initJsChannel();
                    },
                    close: function() {
                        window.svgEditorDialog.dialog('destroy');
                        window.svgEditorDialog.remove();  
                        window.svgEditorFrame.remove();
                        window.svgEditorFrame = null;
                        window.svgEditorDialog = null;
                    },
                    beforeClose: function(event, ui) { 
                        console.log("SVG editor dialog close button clicked");
                        if(window.svgEditorDialog.closeConfirmed){
                            return true;
                        }
                        var fail = function(error, message) { 
                            console.error(error,message); 
                            messageBox.show(
                                "An error occured getting SVG from editor.<br>Error message...<br>" + message + "<br>Press OK to return to the editor or close to return to Node-red (changes may be lost).",
                                "Error getting SVG!",
                                "fa-exclamation-triangle", 
                                {
                                    buttons:{
                                        "OK":function(){
                                            messageBox.close();
                                        },
                                        "Close":function(){
                                            window.svgEditorDialog.closeConfirmed = true;
                                            messageBox.close();
                                            closeJsChannel();
                                            window.svgEditorDialog.dialog("close"); 
                                        }
                                    }
                                }
                            );
                        }
                        var success = function(v) {
                            var svgStr = v.stringSVG;
                            var dirty = v.modified;
                            if(dirty===false){
                                window.svgEditorDialog.closeConfirmed = true;
                                messageBox.close();
                                closeJsChannel();
                                window.svgEditorDialog.dialog("close"); 
                            } else {
                                var options = {
                                buttons : {
                                    "Yes":function(){
                                        sendSVGtoSource(svgStr);
                                        window.svgEditorDialog.closeConfirmed = true;
                                        messageBox.close();
                                        closeJsChannel();
                                        window.svgEditorDialog.dialog("close");
                                    },
                                    "No": function(){
                                        window.svgEditorDialog.closeConfirmed = true;
                                        messageBox.close();
                                        closeJsChannel();
                                        window.svgEditorDialog.dialog("close"); 
                                    },
                                    "Cancel": function(){
                                        window.svgEditorDialog.closeConfirmed = false;
                                        messageBox.close();
                                    }
                                }
                            }
                            messageBox.show("Save changes?", "Confirm", "fa-question", options )
                            }
                        }
                        getSVGData(success, fail);
                        return false;
                     }
                });
                
                // Let's customize the popup dialog, by setting a custom title and a 'Save' menu button (to save intermediate) and a full screen button
                window.svgEditorDialogDiv.parent().find(".ui-dialog-titlebar").append('<button id="btnSave" style="right: 26px" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only ui-dialog-titlebar-close" title="Save"><span class="ui-button-icon ui-icon ui-icon-disk"></span></button>');
                window.svgEditorDialogDiv.parent().find(".ui-dialog-titlebar").append('<button id="btnMaximise" style="right: 48px" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only ui-dialog-titlebar-close" title="Fullscreen"><span class="ui-button-icon ui-icon ui-icon-arrow-2-ne-sw"></span></button>');
                
                window.svgEditorDialog.dialog("option", "width", width);
                window.svgEditorDialog.dialog("option", "height", height);
                window.svgEditorDialog.dialog("open");  

                $("#btnSave").click(function(){
                    saveSVG();
                });
                
                var drawsvgFullScrElement = $('#drawsvg')[0];
                var fsr = drawsvgFullScrElement.requestFullscreen || drawsvgFullScrElement.mozRequestFullScreen || drawsvgFullScrElement.webkitRequestFullscreen || drawsvgFullScrElement.msRequestFullScreen;
                if(fsr){
                    $("#btnMaximise").click(function(e){
                        e.preventDefault()
                        if (node.fullscreen === false) {
                            if (fsr) {
                                fsr.call(drawsvgFullScrElement);//triggers oneditresize()
                            }
                        } else {
                            document.exitFullscreen();//triggers oneditresize()
                        }
                    })
                }                 
            }
            function saveSVG(onSuccess, onError){
                console.log("saveSVG called")
                var fail = function(error, message) { 
                    console.error(error,message); 
                    if(onError){
                        onError(error,message);
                    } else {
                        messageBox.show(message,"Error getting SVG!","fa-exclamation-triangle", {buttons:{"OK":function(){messageBox.close();}}});
                    }
                }
                var success = function(v) {
                    var svgStr = v.stringSVG;
                    var dirty = v.modified;
                    sendSVGtoSource(svgStr);
                    if(onSuccess){
                        onSuccess(v);
                    } else {
                        messageBox.show("Changes have been sent to the SVG source","Save","fa-thumbs-o-up", {buttons:{"OK":function(){messageBox.close();}}} );
                    }                            
                }
                getSVGData(success, fail);
            }

            function getSVGData(onSuccess, onFail) {
                console.log("Calling getSVG method...")
                window.drawSvgCommChannel.call({
                    method: "getSVGObject",
                    params: {},
                    error: onFail,
                    success: onSuccess
                });                
            }

            function closeJsChannel(){
                try {
                    if(window.drawSvgCommChannel){
                        window.drawSvgCommChannel.unbind("onDrawSVGReady");
                        window.drawSvgCommChannel.unbind("onSaveSVG");
                        window.drawSvgCommChannel.destroy();
                    }    
                } catch (error) {    
                }
                window.drawSvgCommChannel = null;
            }
            function initJsChannel(){
                closeJsChannel();
                // Create once a drawsvg channel (to communicate with the editor in the iFrame)
                window.drawSvgCommChannel = Channel.build({
                    debugOutput: true,
                    window: document.getElementById("drawsvg").contentWindow,
                    origin: "*",
                    scope: "drawsvg"
                });
                
                // bind drawsvg ready callback 
                window.drawSvgCommChannel.bind("onDrawSVGReady", function (trans,params) {
                    // now you can communicate with drawsvg
                    console.log("got drawsvg ready notification");
                    // setting document menu
                    // call 'setDocumentMenu' method 
                    // with params {enableSamples, disableTasks}
                    window.drawSvgCommChannel.call({
                        method: "setDocumentMenu",
                        params: {
                            // enable samples sub-menu
                            'enableSamples' : true,
                            // disable save (handled manually)
                            'disableTasks' : 'save new open'
                        },
                        // jsChannel callbacks
                        error: function(error, message) { 
                            console.error(error);
                            messageBox.show(message,"Error setting up editor!","fa-exclamation-triangle", {buttons:{"OK":function(){messageBox.close();}}});
                            },
                        success: function(v) {
                            console.log("setting document menu done");
                            window.drawSvgCommChannel.editorSVGLoaded = true;
                            sendSVGtoEditor()
                        }
                    });                   
                    return "connected";
                });

                // save svg service
                // bind save callback
                window.drawSvgCommChannel.bind("onSaveSVG", function (trans,params) {
                    console.log("onSaveSVG nameSVG="+params['nameSVG']+" stringSVG="+params['stringSVG']);
                    sendSVGtoSource(params['stringSVG'])
                    return "save done";
                });
            }//end initJsChannel()

            function sendSVGtoSource(svgStr) {
                // Convert the SVG string (that we received from DrawSvg) into a temporary DOM tree, which allows us to 
                // search easily through the SVG.  See https://discourse.nodered.org/t/temporary-dom-elements-somewhere-cached/15520
                var svgElement = new DOMParser().parseFromString(svgStr, "image/svg+xml");

                // When the element contains a data-xlink-href, this means it is referring to a local image.  The xlink:href attribute will
                // contain the base64 encoded string of that local image, and the data-xlink-href contains the url (file://...) to that
                // local image.  We will replace the base64 string by the local image url.
                svgElement.querySelectorAll("[data-xlink-href]").forEach(function (element) {
                    var xlinkHref = element.getAttribute("data-xlink-href");
                    element.removeAttribute("data-xlink-href");
                    element.setAttribute("xlink:href", xlinkHref);
                })       

                // Convert the manipulated DOM tree back into an SVG string
                svgStr = new XMLSerializer().serializeToString(svgElement);                        
                
                if(node.autoFormatAfterEdit){
                    svgStr = beautifySVG(svgStr);
                }
                window.node_ace_editor.setValue(svgStr);
            }

            function sendSVGtoEditor(){
                // Since the external cloud editor cannot access local image files, we will load the base64 string (of that image) into the SVG string.
                // For example: xlink:href="file://C:\myimage.png"
                // TODO dit is te laat, want DrawSvg probeert die local links al reeds op te laden:
                //    "Not allowed to load local resource: file:///C:/temp/floorplan.jpg"
                // TODO daarom verhuizen naar onDrawSVGReady?  Probleem is wel dat sendSvgToEditor op 2 plaatsen opgeroepen wordt (en niet enkel uit sendSvgEditor)!!!!!
                var svgString = window.node_ace_editor ? window.node_ace_editor.getValue() : "";
                svgString = svgString.replace(/(xlink:href="file:\/\/)([^"]*)(")/g, function(match, $1, $2, $3, offset, input_string) {
                    var newUrl = "";
                    var fileName = $2;

                    $.ajax({
                        type: "GET",
                        url: "ui_svg_graphics/image/" + node.id + "/" + fileName, 
                        async: false, // Synchronous call
                        success: function(response, status, xhr){ 
                            var contentType = xhr.getResponseHeader("content-type") || "";
                        
                            // Return data url of base64 encoded image string.
                            // And store the original file name in a custom 'data' attribute
                            newUrl = 'xlink:href="data:' + contentType + ';base64,' + response + '" data-xlink-href="file://' + fileName + '"';
                        },
                        error: function() {
                            // Leave the local file path untouched, since we cannot load the specified image
                            newUrl = $1 + $2 + $3;
                        }
                    });

                    return newUrl;
                })
                    
                window.drawSvgCommChannel.call({
                    method: "loadStringSVG",
                    params: {
                        'stringSVG' : svgString,
                        'nameSVG' : 'node-red',// svg name
                        // The name of the service which to be called 
                        // when user clicks on the save button of drawsvg
                        'saveService' :  'onSaveSVG',
                        // don't show save dialog
                        'showSaveDialog' : false,
                        // Change the dimensions of the document to the full window (100%)
                        'fullWindow' : true,
                        // svg loading callbacks
                        'onLoad' : function() {console.log("got svg1 onLoad notification");},
                        'onError': function(err) {
                            console.error(err);
                            messageBox.show(err,"Error loading SVG!","fa-exclamation-triangle", {buttons:{"OK":function(){messageBox.close();}}});
                        }
                    },
                    // jsChannel callbacks
                    error: function(error, message) { 
                        messageBox.show(message,"Error communicating to SVG Editor!","fa-exclamation-triangle", {buttons:{"OK":function(){messageBox.close();}}});
                    },
                    success: function(v) {}
                });
            }//end sendSVGtoEditor()

            $(".node-display-svg-popup").on("click", function (e) {
                console.log("node-display-svg-popup clicked")
                e.preventDefault();
                var winwid = $(window).width();
                var winhei = $(window).height();
                var src = $("#node-input-editorUrl").val();
                var title = $(this).attr("data-title");
                var width = winwid - ((winwid/100)*5);//window width less 5%
                var height = winhei - ((winhei/100)*5);//window height less 5%

                // When the "#jsChannel:" postfix is not available in the URL, then the onDrawSVGReady will never be executed!
                if(!src.endsWith("#jsChannel:")) {
                    src += "#jsChannel:";
                }
                showDrawSVG(src,title,width,height);
            });
            $(".node-format-svg-source").on("click", function (e) {
                try {
                    var svgIn = node.editor.getValue();
                    var svgOut = beautifySVG(svgIn);
                    window.node_ace_editor.setValue(svgOut);
                } catch (error) {
                    console.error(error);
                }       
            });
            function beautifySVG(svg, options){
                var opts = {
                    "indent_size": "2",
                    "indent_char": " ",
                    "max_preserve_newlines": "-1",
                    "preserve_newlines": false,
                    "keep_array_indentation": false,
                    "break_chained_methods": true,
                    "indent_scripts": "normal",
                    "brace_style": "expand",
                    "space_before_conditional": true,
                    "unescape_strings": false,
                    "jslint_happy": false,
                    "end_with_newline": false,
                    "wrap_line_length": "0",
                    "indent_inner_html": false,
                    "comma_first": false,
                    "e4x": false,
                    "indent_empty_lines": false
                };
                $.extend(opts, options);//merge options into opts (in case of duplicates, options takes precidence)
                return html_beautify(svg,opts);
            }
            
            $("#node-input-restoreUrl").on("click", function (e) {
                $("#node-input-editorUrl").val("http://drawsvg.org/drawsvg.html");
            });
            setTimeout(function() {
                $("#node-input-name").css({"width":"70%"});    
            }, 50);//workaround for odd over sizing of name field            
        },
        oneditsave: function() {
            var node = this;
            var annot = this.editor.getSession().getAnnotations();
            this.noerr = 0;
            $("#node-input-noerr").val(0);
            for (var k=0; k < annot.length; k++) {
                if (annot[k].type === "error") {
                    $("#node-input-noerr").val(annot.length);
                    this.noerr = annot.length;
                }
            }
            
            var svgString = this.editor.getValue();
            $("#node-input-svgString").val(svgString);
            this.editor.destroy();
            delete this.editor;
            delete window.node_ace_editor;
            // Copy all the animations from the editableList to this node
            node.smilAnimations = [];
            var smilAnimationsList = $("#node-input-animations-container").editableList('items');
            smilAnimationsList.each(function(i) {
                var amin = getAnimationObjectFromFormRow(this);
                node.smilAnimations.push(amin);
            });
            
            // Copy all the clickable shapes from the editableList to this node
            node.clickableShapes = [];
            var clickableShapesList = $("#node-input-clickable-container").editableList('items');
            clickableShapesList.each(function(i) {
                var clickableShape = $(this);
                var targetId = clickableShape.find(".node-input-clickable-targetId").val();
                var action = clickableShape.find(".node-input-clickable-action").val();
                var payload  = clickableShape.find(".node-input-clickable-payload").val();
                var payloadType  = clickableShape.find(".node-input-clickable-payloadType").val();
                var topic    = clickableShape.find(".node-input-clickable-topic").val();
                
                node.clickableShapes.push({targetId:targetId, action:action, payload:payload, payloadType:payloadType, topic:topic});
            });
            // Copy all the bindings from the editableList to this node
            node.bindings = [];
            var bindingList = $("#node-input-binding-container").editableList('items');
            bindingList.each(function(i) {
                var amin = getBindingFromFormRow(this);
                node.bindings.push(amin);
            });
            window.node_ace_editor = null;
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
            delete window.node_ace_editor;
        },
        oneditresize: function(size) {
            updateEditorHeight(this,this.editor);
        }
    });
</script>


<script type="text/html"  data-template-name="ui_svg_graphics">
    <div class="form-row" id="template-row-group">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</span></label>
        <input type="text" id="node-input-group">
    </div>    
    <div class="form-row" id="template-row-size">
        <label><i class="fa fa-object-group"></i> Size</span></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <!-- Tabsheets -->
        <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-svg-tabs"></ul>
    </div>
    <div id="node-svg-tabs-content" style="min-height: 150px">
        <!-- Content of all tabsheets -->
        <div id="node-svg-tab-editor" class="node-svg-tab-content" style="position: relative; text-align: center; margin-top: 30px;">           
            <button id="node-display-svg-popup" 
                class="svgButton node-display-svg-popup" 
                data-href="http://drawsvg.org/drawsvg.html#jsChannel:" 
                data-title="SVG Editor">
                <div class="svgButtonIcon">  
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 60 60" version="1.1"><!-- Generator: Sketch 51.3 (57544) - http://www.bohemiancoding.com/sketch --><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="012---Edit-Text" fill="#ffffff" fill-rule="nonzero"><path d="M11.92,16 L18.08,16 C18.5816184,16.0001393 19.0501055,15.7495298 19.3283997,15.332189 C19.6066939,14.9148482 19.6579559,14.3860216 19.465,13.923 L16.384,6.523 C16.1510259,5.96417691 15.6049421,5.60019992 14.9995,5.60019992 C14.3940579,5.60019992 13.8479741,5.96417691 13.615,6.523 L10.535,13.923 C10.3420441,14.3860216 10.3933061,14.9148482 10.6716003,15.332189 C10.9498945,15.7495298 11.4183816,16.0001393 11.92,16 Z M15,8.4 L17.331,14 L12.669,14 L15,8.4 Z" id="Shape"/><path d="M2,29 L8,29 C9.1045695,29 10,28.1045695 10,27 L10,26 C9.99715878,25.0134931 9.51156415,24.0908633 8.7,23.53 L10.167,20 L19.833,20 L21.588,24.217 C21.2052017,24.7325545 20.9989841,25.3578707 21,26 L21,27 C21,28.1045695 21.8954305,29 23,29 L29,29 C30.1045695,29 31,28.1045695 31,27 L31,26 C30.9978857,24.4411833 29.8041514,23.1427964 28.251,23.01 L19.18,1.231 C18.8694142,0.485331324 18.1407656,-0.000302895298 17.333,4.23429917e-17 L13.667,4.23429917e-17 C12.8592344,-0.000302895298 12.1305858,0.485331324 11.82,1.231 L2.749,23.01 C1.19584863,23.1427964 0.00211433151,24.4411833 0,26 L0,27 C2.09738034e-15,28.1045695 0.8954305,29 2,29 Z M2,26 C2,25.4477153 2.44771525,25 3,25 L3.42,25 C3.8238222,24.9998655 4.18793229,24.7568624 4.343,24.384 L13.667,2 L17.333,2 L26.657,24.384 C26.8120677,24.7568624 27.1761778,24.9998655 27.58,25 L28,25 C28.5522847,25 29,25.4477153 29,26 L29,27 L23,27 L23,26 C23.0040027,25.6919001 23.1455981,25.4017395 23.386,25.209 C23.7335967,24.9312445 23.8558685,24.4572375 23.686,24.046 L21.686,19.231 C21.3745779,18.4833108 20.6429478,17.9972683 19.833,18 L10.167,18 C9.35935132,17.998312 8.63044906,18.4839836 8.321,19.23 L6.477,23.655 C6.36218989,23.9308511 6.37674397,24.243589 6.51667728,24.5075849 C6.65661059,24.7715808 6.90726124,24.9591738 7.2,25.019 C7.6639235,25.1176028 7.99674471,25.5257248 8,26 L8,27 L2,27 L2,26 Z" id="Shape"/><path d="M42.112,51.28 L48.292,50.044 C48.7763649,49.9476703 49.2211865,49.7095967 49.57,49.36 L52.546,46.384 C52.8074121,46.1224696 53.007553,45.806206 53.132,45.458 L59.83,26.7 C60.1163189,25.8892813 59.9117422,24.9861881 59.304,24.378 C58.9974834,24.0764266 58.6077918,23.8733969 58.185,23.795 C58.0609259,23.1593718 57.6659496,22.6093993 57.1032643,22.2887705 C56.540579,21.9681417 55.8660838,21.908709 55.256,22.126 L54,22.578 L54,11.57 C54,7.243 54,-4.46691295e-16 44.75,-4.46691295e-16 C41.8428326,-0.0184684772 38.9763984,0.683795856 36.407,2.044 C35.644589,2.48300306 35.2585826,3.36866658 35.456,4.226 L36.067,6.861 C36.2048502,7.44824596 36.60225,7.94094808 37.147,8.2 C37.700402,8.46245662 38.3430249,8.45951388 38.894,8.192 C40.5309628,7.41085175 42.3212122,7.00368187 44.135,7 C44.9108183,6.95485539 45.6886512,7.04244614 46.435,7.259 C46.868,7.431 47.135,7.689 47.117,8.459 C47.117,8.721 47.104,9.43 47.084,9.999 C43.129,10.023 39.384,10.416 36.522,13.18 C33.8430608,15.7163103 32.7839886,19.5248154 33.769,23.08 C34.4752821,25.3657456 36.1535984,27.2237116 38.356,28.158 L36.499,28.822 C36.1505681,28.9465849 35.8340068,29.1466981 35.572,29.408 L32.6,32.39 C32.2502828,32.7383242 32.0121712,33.1828688 31.916,33.667 L30.68,39.848 C30.6604756,39.944649 30.6128111,40.0333678 30.543,40.103 L29.087,41.559 C28.3120731,41.44701 27.5296358,41.7063405 26.975,42.259 L22.732,46.5 C21.7560452,47.4762496 21.7560452,49.0587504 22.732,50.035 L31.925,59.228 C32.9012496,60.2039548 34.4837504,60.2039548 35.46,59.228 L39.7,54.985 C40.2526877,54.4299699 40.5119963,53.6472283 40.4,52.872 L41.855,51.417 C41.9251744,51.3468432 42.0146368,51.2991531 42.112,51.28 Z M35.688,22.511 C34.9121205,19.6709117 35.7689319,16.63456 37.915,14.619 C40.461,12.162 44,11.975 48,12 C49.12,12 49.12,11.108 49.12,8.48 C49.2462734,7.13167591 48.44905,5.86728451 47.178,5.4 C46.2008824,5.07528136 45.1708835,4.93953192 44.143,5 C42.0210586,5.00286873 39.9267357,5.4812587 38.014,6.4 L37.378,3.788 C39.6499936,2.59241307 42.1827243,1.97812626 44.75,2 C51.48,2 52,5.966 52,11.57 L52,23.292 L41.7,26.971 C38.9498397,26.9188443 36.5355672,25.1278171 35.688,22.511 Z M34.046,57.811 C33.8507501,58.006191 33.5342499,58.006191 33.339,57.811 L24.146,48.619 C23.950809,48.4237501 23.950809,48.1072499 24.146,47.912 L25.914,46.144 L35.814,56.044 L34.046,57.811 Z M38.289,53.569 L37.228,54.629 L27.328,44.729 L28.389,43.668 C28.5842499,43.472809 28.9007501,43.472809 29.096,43.668 L38.289,52.86 C38.3839648,52.9539219 38.437404,53.0819349 38.437404,53.2155 C38.437404,53.3490651 38.3839648,53.4770781 38.289,53.571 L38.289,53.569 Z M40.442,50 L39.349,51.1 L30.864,42.61 L31.956,41.518 C32.3060603,41.1693879 32.5445057,40.7245218 32.641,40.24 L33.876,34.06 C33.8956185,33.9628781 33.9436507,33.8737748 34.014,33.804 L36.989,30.828 C37.0415571,30.7756902 37.1050912,30.7357252 37.175,30.711 L42.187,28.921 L42.217,28.91 L53.379,24.923 L53.394,24.923 L55.929,24.023 C56.0270919,23.9893025 56.1355093,24.0270242 56.1914999,24.1143316 C56.2474905,24.201639 56.2365456,24.3159083 56.165,24.391 L47.027,33.528 C45.2921917,32.5044983 43.0669597,32.9305994 41.8329806,34.5225829 C40.5990016,36.1145663 40.7412587,38.3757569 42.1650296,39.8005347 C43.5888005,41.2253126 45.84989,41.3691682 47.4427454,40.1363149 C49.0356008,38.9034617 49.463275,36.6785314 48.441,34.943 L57.579,25.8 C57.6148455,25.7480819 57.6739097,25.7170871 57.737,25.7170871 C57.8000903,25.7170871 57.8591545,25.7480819 57.895,25.8 C57.9552035,25.8602422 57.9754329,25.9497182 57.947,26.03 L51.247,44.785 C51.2219361,44.8544504 51.1820056,44.9175884 51.13,44.97 L48.154,47.946 C48.0840966,48.0159836 47.9950061,48.0636609 47.898,48.083 L41.718,49.319 C41.2346347,49.4146911 40.790548,49.6516998 40.442,50 Z M46.42,38.368 C45.6286285,39.1233037 44.3833715,39.1233037 43.592,38.368 C43.0198788,37.7960515 42.8486566,36.9357685 43.1581832,36.1883456 C43.4677098,35.4409226 44.1970205,34.9535729 45.006,34.9535729 C45.8149795,34.9535729 46.5442902,35.4409226 46.8538168,36.1883456 C47.1633434,36.9357685 46.9921212,37.7960515 46.42,38.368 Z" id="Shape"/><path d="M48.021,15 C44.864,14.938 41.384,15.12 39.475,16.99 C38.5782384,17.8810069 38.0936816,19.1056273 38.138,20.369 C38.0600373,21.6119005 38.5167928,22.8289002 39.3932666,23.7135885 C40.2697404,24.5982768 41.4824264,25.066365 42.726,25 C45.4244899,25.0565985 47.8511361,23.3652997 48.732,20.814 C48.9003341,20.3224135 48.9907597,19.8075269 49,19.288 L49,16 C49.00012,15.4558134 48.5650666,15.0114279 48.021,15 Z M47,19.288 C46.9910731,19.5902336 46.9361079,19.8893385 46.837,20.175 C46.2402391,21.9206983 44.5696005,23.068729 42.726,23 C42.0143431,23.0634839 41.311628,22.8051131 40.8105918,22.2957521 C40.3095556,21.7863912 40.0627986,21.0795143 40.138,20.369 C40.0984418,19.6442692 40.3659812,18.9363968 40.875,18.419 C42.094,17.224 44.762,17 47,16.99 L47,19.288 Z" id="Shape"/><path d="M3,30 C2.44771525,30 2,30.4477153 2,31 L2,39 C2,39.5522847 2.44771525,40 3,40 C3.55228475,40 4,39.5522847 4,39 L4,36 L27,36 L27,39 C27,39.5522847 27.4477153,40 28,40 C28.5522847,40 29,39.5522847 29,39 L29,31 C29,30.4477153 28.5522847,30 28,30 C27.4477153,30 27,30.4477153 27,31 L27,34 L4,34 L4,31 C4,30.4477153 3.55228475,30 3,30 Z" id="Shape"/></g></g></svg>              
                </div>
                <div class="svgButtonText">Open SVG Editor</div>
            </button>
            <div id="node-display-svg-popup-no-url" style="position: absolute; top: 50%; left: 50%; margin-right: -50%; transform: translate(-50%, -50%); background-color: rgb(235, 235, 235);" 
                class="form-tips">
                <i class="fa fa-globe"></i> Editor URL is not set! Update the URL on the <a id="gotoSettingsButton" href="javascript:void(0)" class="red-ui-tab-label" title="Settings">Settings</a> tab.
            </div>
        </div>        
        <div id="node-svg-tab-source" class="node-svg-tab-content">
            <!-- Ace SVG source editor -->
            <div class="form-row" style="margin-bottom:0px;">
                <input type="hidden" id="node-input-svgString" style="width: 100%; height: 100%; ">
            </div>
            <div class="form-row node-source-editor-row form-row-auto-height">
                <div id="node-input-svg-source" class="node-source-editor" style="width: 100%; height: 100%; min-height:150px;"></div>
                <button id="node-expand-svg-source" class="node-expand-svg-source editor-button editor-button-small" style="margin-top: 4px;" title="Expand source">
                    <i class="fa fa-expand"></i>
                </button>
                <button id="node-format-svg-source" class="node-format-svg-source editor-button editor-button-small" style="margin-top: 4px;" title="Format SVG">
                    <i class="fa fa-code"></i>    
                </button>
            </div>
        </div>
        <div id="node-svg-tab-animations" class="node-svg-tab-content">
            <div class="form-row form-row-auto-height">
                <!-- Table with SMIL animations -->
                <ol id="node-input-animations-container"></ol>
            </div>
        </div>
        <div id="node-svg-tab-clickable" class="node-svg-tab-content">
            <div class="form-row" style="padding-left: 2px;">
                <label for="node-input-outputField"><i class="fa fa-envelope"></i> Output to</label>
                <div class="red-ui-typedInput-container" style="width: 70%; margin-right: 5px; margin-left: 3px;">    
                    <button class="red-ui-typedInput-type-select"> 
                        <span class="red-ui-typedInput-type-label">msg.</span>
                    </button>
                    <div class="red-ui-typedInput-input-wrap" style="left: 46px; right: 2px;">
                        <input type="text" id="node-input-outputField" placeholder="payload" style="width: 100%; margin-right: 0px; margin-left: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px;" autocomplete="disable" dir="" class="red-ui-typedInput-input">
                    </div>
                </div>
            </div>
            <div class="form-row form-row-auto-height">
                <!-- Table with clickable shapes -->
                <ol id="node-input-clickable-container"></ol>
            </div>
        </div>
        <div id="node-svg-tab-binding" class="node-svg-tab-content">
            <div class="form-row form-row-auto-height">
                <!-- Table with clickable shapes -->
                <ol id="node-input-binding-container"></ol>
            </div>   
        </div>   
        <div id="node-svg-tab-settings" class="node-svg-tab-content">
            <div class="form-row">
                <input type="checkbox" id="node-input-showCoordinates" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-showCoordinates" style="width:70%;"> Show mouse coordinates (as tooltip)</label>
            </div>
            <div class="form-row">
                <input type="checkbox" id="node-input-autoFormatAfterEdit" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-autoFormatAfterEdit" style="width:70%;"> Auto format SVG Source after saving edits in SVG Editor</label>
            </div>
            <div class="form-row" id="div-editorUrl">
                <label for="node-input-editorUrl"><i class="fa fa-globe"></i> Editor URL</label>
                <input type="text" id="node-input-editorUrl">
                <button id="node-input-restoreUrl" class="editor-button" title="Restore default URL""><i class="fa fa-undo"></i></button>
            </div>
            <div class="form-row">
                <label for="node-input-directory"><i class="fa fa-folder"></i> Directory</label>
                <input type="text" id="node-input-directory" placeholder="Select directory">
            </div>
            </br>
            <div class="form-row">
                <input type="checkbox" id="node-input-panEnabled" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-panEnabled" style="width:70%;"> Enable panning</label>
            </div>    
            <div class="form-row">
                <input type="checkbox" id="node-input-zoomEnabled" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-zoomEnabled" style="width:70%;"> Enable zooming</label>
            </div>   
            <div class="form-row">
                <input type="checkbox" id="node-input-controlIconsEnabled" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-controlIconsEnabled" style="width:70%;"> Enable control icons</label>
            </div>   
            <div class="form-row">
                <input type="checkbox" id="node-input-dblClickZoomEnabled" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-dblClickZoomEnabled" style="width:70%;"> Enable double-click zooming</label>
            </div>   
            <div class="form-row">
                <input type="checkbox" id="node-input-mouseWheelZoomEnabled" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-mouseWheelZoomEnabled" style="width:70%;"> Enable mouse-wheel zooming</label>
            </div>              
        </div>
    </div>
</script>
<script type="text/html" data-help-name="ui_svg_graphics">
    <p>A Node Red node to show a vector graphics (SVG) drawing inside the dashboard.</p>
    <p>See our readme page on <a target="_blank" href="https://github.com/bartbutenaers/node-red-contrib-ui-svg">Github</a> for more information.</p>
    <h3>General Properties...</h3>
    <dl class="message-properties">
        <h4>Group</h4>
        <div style="padding-left: 15px">
            Where you want the SVG to be displayed on your dashboard.
        </div>
        <h4>Size</h4>
        <div style="padding-left: 15px">
            The size of the widget on the dashboard
        </div>    
        <h4>Name</h4>
        <div style="padding-left: 15px">
            The name of this node 
        </div>
        <h3><b>Tabs...</b></h3>
        <h4>Editor</h4>
        <div style="padding-left: 15px">
            Click the button to open the SVG drawing in the DrawSvg drawing editor.
            <p><i>NOTE: SVG Editor will not be available if the <code>Editor URL</code> on the settings tab is empty!</i></p>
            <p><strong>!!! DrawSvg is free software. DrawSvg IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED !!!</strong></p>
        </div>
        <h4>SVG source</h4>
        <div style="padding-left: 15px">
            The raw SVG to be displayed. The SVG source can be edited directly here. 
            <p>Buttons...</p>
            <ul>
                <li><span class="editor-button editor-button-small" style="margin-top: 4px;" title="Expand source">
                        <i class="fa fa-expand"></i>    
                    </span> will expand the SVG source editor to full screen.
                </li>
                <li><span class="editor-button editor-button-small" style="margin-top: 4px;" title="Format SVG">
                        <i class="fa fa-code"></i>    
                    </span> will reformat the SVG source code.
                </li>
            </ul>
        </div>
        <h4>Animations</h4>
        <div style="padding-left: 15px">
            A customisable list of animations. Each animation targets an element where you can specify an attribute to animate. 
            <p>Notes...</p>
            <ul>
                <li>The <code>Animation id</code> specifies the id to apply to this animation.</li>
                <li>The <code>Target Element id</code> specifies what element to apply the animation to.</li>
                <li><code>Class</code> The class field permits you to adress animations by a class name. e.g. you could send a <code>msg</code> to "trigger_animation" of all animations with <code>selector</code> ".spinners" </ul>
                <li>The <code>Attribute name</code> specifies what attribute to animate</li>
                <li>The <code>from</code> and <code>to</code> values specifies what begining and end value of the animation</li>
                <li><code>Animation end</code>
                    <ul>
                        <li>Freeze new value: Keep the animation end value at the animation end</li>
                        <li>Restore original value: Restore the original value at the animation end</li>
                    </ul>
                </li>
                <li><code>Trigger</code> 
                    <ul>
                        <li>Input Message: Dont start the animation, instead, wait for a <code>msg</code> (See Triggering an animation command below) </li>
                        <li>Time Delay: Start animation after a specified time</li>
                        <li>Custom: Use standard <code>begin</code> options e.g. <code>2s; myRect.click; myAnim.end-400ms</code> <i target="blank" href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/begin">See here</i>.  </li>
                    </ul>
                </li>
            </ul>
        </div>        
        <h4>Events</h4>
        <div style="padding-left: 15px">
            A customisable list of events. Each event targets an element where you can specify what action (e.g. click, mouseover, focus, etc) and a payload/topic to send upon the specified action.
            Additionally, <code>Output to</code> permits you to specify what part of the <code>msg</code> to send the payload to.
        </div>
        <h4>Input Bind</h4>
        <div style="padding-left: 15px">
            A customisable list of bindings that permit the user to easily specify text and attribute binding.  
            e.g. it is possible to send a <code>msg</code> object with nested objects/properties to animate an elements' text and attributes as specified in this list.
            <ul>
                <li><b>Source</b> - What properties in the <code>msg</code> you wish to use as the value in this binding</li>
                <li><b>Selector</b> - What elements this binding should work on (e.g. <code>.indicators</code> would affect all elements in the SVG with class="indicators")</li>
                <li><b>Destination</b> - 
                    <ul>
                        <li>If <code>Text</code> is selected, the inner text content of the element will be updated with the value of the binding source.</li>
                        <li>If <code>Attribute</code> is selected, the attribute specified in the next input will be updated with the value of the binding source.</li>
                    </ul>    
                </ul>
            </ul>
            <p>Notes: The <code>topic</code> must be set to <code>databind</code></p>
        </div>
    </dl>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt><i>payload (see 'Output to')</i> <span class="property-type">number|string|boolean|object|buffer</span></dt>
        <dd>msg.[Output to] will contain whatever is configured in 'payload'</dd>
        <dd>e.g. if 'Output to' is set to <b>data.value</b> then <code>msg.data.value</code> will contain the value of the <i>payload</i></dd>
        <dd>Additional properties are also added to the msg object. Check the debug output (use show complete msg)</dd>
    </dl>

    <h3>Inputs - Commands <i>(Advanced Usage)</i></h3>
    <dl class="message-properties">
        <dt><i>payload</i> <span class="property-type">string|object|Array</span></dt>
        <dd>It is possible to dynamically trigger animations, set/update/remove element attributes, set/update/remove style attributes, update text and innerHTML via a <code>msg</code></dd>
        <dd>
            <p><b>Triggering an animation command - payload object</b><br>Example...<br>
                <pre style="white-space: pre">[
 {
    "command": "trigger_animation",
    "selector": "#myAnimation",
    "action": "start"
 }
]</pre>
                
                <p><i>Details...</i><br>
                    <ul>
                        <li>command: (string|required) The operation to perform</li>
                        <li>selector: (string|required) A query selector to select the animations</li>
                        <li>action: (string|required) This must be <code>start</code>or <code>stop</code></li>
                    </ul>
                </p>
            </p>


            <p><b>Setting an attribute value command - payload object</b><br>Example...<br>
                <pre style="white-space: pre">[
 {
    "command": "update_attribute",
    "selector": "#myRect > .statusBar",
    "attributeName": "fill",
    "attributeValue": "red"
 },
 {
    "command": "update_attribute",
    "selector": "#myRect > .faultMessage",
    "attributeName": "display",
    "attributeValue": "inline"
 }
]</pre>
                
                <p><i>Details...</i><br>
                    <ul>
                        <li>command: (string|required) The operation to perform</li>
                        <li>selector: (string|required) A query selector to select the animations</li>
                        <li>attributeName: (string|required) This attribute be updated</li>
                        <li>attributeValue: (string|number|required) The value to set the attribute specified by <code>attributeName</code></li>
                    </ul>
                </p>
                <p><i>Notes...</i><br>
                    An attribute can be removed by sending an empty string for the attributeValue.<br> 
                    <code>set_attribute</code> can be used in place of <code>update_attribute</code>.<br> 
                    <code>update_attribute</code> will only change an existing attribute.<br> 
                    <code>set_attribute</code> will add the attribute if it does not already exist.
                </p>
            </p>



            <p><b>Setting a style value command - payload object</b><br>Example...<br>
                <pre style="white-space: pre">[
 {
    "command": "update_style",
    "selector": "#myRect > .statusBar",
    "attributeName": "fill",
    "attributeValue": "red"
 },
 {
    "command": "update_style",
    "selector": "#myRect > .faultMessage",
    "style": {"display": "inline", "fill": "blue", "transform": "rotate(5deg)"} 
 }
]</pre>
                                
                <p><i>Details...</i><br>
                    Named style attribute change...
                    <ul>
                        <li>command: (string|required) The operation to perform</li>
                        <li>selector: (string|required) A query selector to select the animations</li>
                        <li>attributeName: (string|required) This attribute be updated</li>
                        <li>attributeValue: (string|number|required) The value to set the attribute specified by <code>attributeName</code></li>
                    </ul>
                    Style object attribute(s) change...
                    <ul>
                        <li>command: (string|required) The operation to perform</li>
                        <li>selector: (string|required) A query selector to select the animations</li>
                        <li>style: (object|required) The style(s) to be updated</li>
                    </ul>
                </p>                
                <p><i>Notes...</i><br>
                    A style value can be reset by sending an empty string for the attributeValue or style object property value. <br>
                    <code>set_style</code> can be used in place of <code>update_style</code> *(These are operationally the same command)*.
                </p>
            </p>
            

            <p><b>Setting text content command</b><br>Example...<br>
                <P>Topic Method</P>
                <pre style="white-space: pre">
 //send a msg with topic formatted as...   
 //  update_text|selector  
 //... and the payload with the text to display
 var msg = {
    "topic": "update_text|#myRect > .faultMessage",
    "payload": "hello"
 }
 return msg;</pre>

                <P>Command Method - payload object</P>
                <pre style="white-space: pre">[
 {
    "command": "update_text",
    "selector": "#myRect > .faultMessage",
    "text": "Hello from a command message"
 }
]</pre>
                
                <p><i>Topic Method Details...</i><br>
                    <ul>
                        <li>topic: (string|required) The format must adhere to "update_text|selector"</li>
                        <li>payload: (string|required) The text to set</li>
                    </ul>
                </p>
                
                <p><i>Command Method Details...</i><br>
                    <ul>
                        <li>selector: (string|required) A query selector to select the animations</li>
                        <li>text: (string|required) The text to set</li>
                    </ul>
                    NOTE: <code>text</code> can contain SVG markup.
                </p>
            </p>


            <p><b>Setting inner HTML command</b><br>Example...<br>
                <P>Command - payload object</P>
                <pre style="white-space: pre">[
 {
    "command": "update_innerHTML",
    "selector": "#myRect > .faultMessage",
    "html": "<b>Hello</b> <i>from a command message</i>"
 }
]</pre>

                <p><i>Details...</i><br>
                    <ul>
                        <li>selector: (string|required) A query selector to select the animations</li>
                        <li>html: (string|required) The html/SVG markup to be set</li>
                    </ul>
                </p>
            </p>            

        </dd>

        <h3>Inputs - databind <i>(Advanced Usage)</i></h3>
        <dl class="message-properties">
            <dt><i>topic</i> <span class="property-type">string</span></dt>
            <dd>When <code>topic</code> is set to <code>databind</code> text content and attributes can be updated by properties of <code>payload</code></dd>
            <dt><i>payload</i> <span class="property-type">string|object|Array</span></dt>
            <dd>It is possible to update text content and element attributes by setting the appropriate <code>data-bind</code> attribute & sending an input msg to the node</dd>
            <dd>
                <p>
                    Example SVG...<br>
                        <pre style="white-space: pre">&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:svg=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;&gt;
    &lt;circle data-bind-attributes=&quot;fill,r&quot; data-bind-values=&quot;payload.circleColour,payload.size&quot; cx=&quot;350&quot; cy=&quot;120&quot; r=&quot;25&quot; stroke-width=&quot;0&quot; fill=&quot;lime&quot;/&gt;
    &lt;text data-bind-text=&quot;payload.pressure&quot; x=&quot;342&quot; y=&quot;128&quot; stroke=&quot;black&quot; font-size=&quot;16&quot; text-anchor=&quot;left&quot;&gt; --- &lt;/text&gt; 
    fill=&quot;#FF0000&quot;/&gt;
&lt;/svg&gt;</pre>
                    Example payload...<br>
                        <pre style="white-space: pre">[
    {
        "topic": "databind",
        "payload": {
            "circleColour": "red",
            "size": "40",
            "pressure": 44
        }
    }
]</pre>
                </p>
            </dd>
        </dl>            
    
            <dd>GENERAL NOTES...<br>
        <ul>
            <li>Multiple commands objects can be executed if the payload is an array of objects</li>
            <li>Multiple elements can be addressed by the selector (e.g. ".status" would operate on all elements with class "status")</li>
        </ul>
        </dd>
    </dl>
</script>
